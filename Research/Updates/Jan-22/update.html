<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../../../styles.css">
  <title>January 2022</title>
</head>
<body>

  <ul class="banner">
    <li><a href="https://mkosh.github.io/webkosh/">Home</a></li>
    <li><a class="active_tab" href="https://mkosh.github.io/webkosh/updates.html">Updates</a></li>
    <li><a href="https://github.com/MKosh">GitHub</a>
    <li><a href="https://mkosh.github.io/webkosh/about.html">About</a></li>
  </ul>

  <div class="update_page">
    <h2>Updates</h2>
    <hr class="break">

    <ul>
      <button class="collapsible">Week of: Jan 2th, 2022</button>
      <div class="content">
        <li>I made another set of control plots using the BDT>0.028 cut. The MC events are an order of magnitude lower than it was with the cut based selection, and the data is an order of magnitude higher than the cut based selection. You can see those in the first set of plots. I also made a set of plots using both the selection cuts and the BDT cut, and got the plots on the second set of plots. These both look much worse than the cut based selection alone. Since I applied the preselection cuts (the SR cuts) to the MC samples before the training even happened the max amount of background + signal for the MC samples is ~7500 events. Those 7500 events are what got passed to the output file. Any extra cut applied (different than just the SR cut) will take the MC event counts even lower than the 7500. But the data will not necessarily go low enough to match the MC samples. Because all ~7x10^6 data events got directly passed to the output file, it's starting from more events and the BDT cut alone doesn't bring it down to the same order of magnitude as the MC samples. But the BDT cut does bring down the MC samples even lower than the 7500 events that they start with. Hence the high data event counts, and low MC sample event counts for the first set of plots.</li>
      
        <div class="row">
          <div class="column2">
            <a href="img/BDT_control_plots.pdf">
              <img src="img/c4_Run2_BDT_SR.png" width="400" height="400"/>
            </a>
          </div>
          <div class="column2">
            <a href="img/MVA_and_Cuts_control_plots.pdf">
              <img src="img/c4_Run2_test.png" width="400" height="400"/>
            </a>
          </div>
        </div>
        <div class="update">UPDATE: These make sense in light of the plots below. The first set of plots incorrectly didn't include the <span class="inline_code">full_wv_sr</span> cuts. The second set did, but the data was way too low. Looking at the plots of the BDT response you can see that the data doesn't match the simulation at all, and is specifically low above the BDT cut value of 0.028, which would explain why the data is low when only plotting events in that region. This is corrected in the Week of Jan 23rd updates.</div>
      </div>
      <hr class="break">
      
      <button class="collapsible">Week of: Jan 9th, 2022</button>
      <div class="content">
        <li>I updated the plotting functions even more to make creating and saving plots even easier. Maybe one day I'll  be done making changes to them. Here are the plots for each year, both from the individual year training, and  from the full run 2 split apart. Background event numbers are close, generally off by 1-10 events per background   type (they should match perfectly). These plots are are of the TMVA variables and the three best MVA method   responses (based on AUC). BDT2 is just a normal BDT with optimized hyperparameters. BDTG is a BDT that uses a   gradient boost algorithm. There's no scaling factors applied to anything, but the full run 2 matches fairly well  without it. The individual years a little less so. I don't see anything obvious that would be causing the MVA  responses to have such a dramatic mismatch. I also have the variable rankings listed below for BDT2 and BDTG. I  can't find my ranking list for the DNN, I'll probably have to retrain to get the list again.</li>
        <br>
        <div class="row">
          <div class="column3"><h5 class="link"><a href="img/week_of_9th/2016_TMVA.pdf">Individual 2016</a></h5></div>
          <div class="column3"><h5 class="link"><a href="img/week_of_9th/Run2_TMVA_2016.pdf">Run 2 2016</a></h5></div>
          <div class="column3"><h5 class="link"><a href="img/week_of_9th/2017_TMVA.pdf">Individual 2017</a></h5></div>
          <div class="column3"><h5 class="link"><a href="img/week_of_9th/Run2_TMVA_2017.pdf">Run 2 2017</a></h5></div>
          <div class="column3"><h5 class="link"><a href="img/week_of_9th/2018_TMVA.pdf">Individual 2018</a></h5></div>
          <div class="column3"><h5 class="link"><a href="img/week_of_9th/Run2_TMVA_2018.pdf">Run 2 2018</a></h5></div>
          <div class="column3"><h5 class="link"><a href="img/week_of_9th/Run2_multiplot.pdf">Full Run 2</a></h5></div>
        </div>
        <br>
        <div>
          <div class="row">
            <div class="column3">
              <table width="100%">
                <tr>
                  <th>BDT2 Variable</th>
                  <th>Rank</th>
                </tr>
                <tr>
                  <td>vbf_m</td>
                  <td>1</td>
                </tr>
                <tr>
                  <td>bos_PuppiAK8_tau2tau1</td>
                  <td>2</td>
                </tr>
                <tr>
                  <td>lep1_eta</td>
                  <td>3</td>
                </tr>
                <tr>
                  <td>bos_PuppiAK8_m_sd0_corr</td>
                  <td>4</td>
                </tr>
                <tr>
                  <td>zeppHad</td>
                  <td>5</td>
                </tr>
                <tr>
                  <td>zeppLep</td>
                  <td>6</td>
                </tr>
                <tr>
                  <td>vbf2_AK4_qgid</td>
                  <td>7</td>
                </tr>
                <tr>
                  <td>vbf1_AK4_qgid</td>
                  <td>8</td>
                </tr>
                <tr>
                  <td>vbf2_AK4_eta</td>
                  <td>9</td>
                </tr>
                <tr>
                  <td>vbf_deta</td>
                  <td>10</td>
                </tr>
                <tr>
                  <td>vbf_eta</td>
                  <td>11</td>
                </tr>
                <tr>
                  <td>vbf1_AK4_eta</td>
                  <td>12</td>
                </tr>
                <tr>
                  <td>nJet30f</td>
                  <td>13</td>
                </tr>
                <tr>
                  <td>vbf1_AK4_pt</td>
                  <td>14</td>
                </tr>
                <tr>
                  <td>vbf2_AK4_pt</td>
                  <td>15</td>
                </tr>
              </table>
            </div>
            <div class="column3">
              <table width="100%">
                <tr>
                  <th>BDTG Variable</th>
                  <th>Rank</th>
                </tr>
                <tr>
                  <td>bos_PuppiAK8_m_sd0_corr</td>
                  <td>1</td>
                </tr>
                <tr>
                  <td>zeppHad</td>
                  <td>2</td>
                </tr>
                <tr>
                  <td>bos_PuppiAK8_tau2tau1</td>
                  <td>3</td>
                </tr>
                <tr>
                  <td>lep1_eta</td>
                  <td>4</td>
                </tr>
                <tr>
                  <td>vbf_eta</td>
                  <td>5</td>
                </tr>
                <tr>
                  <td>zeppLep</td>
                  <td>6</td>
                </tr>
                <tr>
                  <td>vbf1_AK4_eta</td>
                  <td>7</td>
                </tr>
                <tr>
                  <td>vbf2_AK4_qgid</td>
                  <td>8</td>
                </tr>
                <tr>
                  <td>vbf2_AK4_eta</td>
                  <td>9</td>
                </tr>
                <tr>
                  <td>vbf_m</td>
                  <td>10</td>
                </tr>
                <tr>
                  <td>vbf_deta</td>
                  <td>11</td>
                </tr>
                <tr>
                  <td>vbf1_AK4_qgid</td>
                  <td>12</td>
                </tr>
                <tr>
                  <td>nJet30f</td>
                  <td>13</td>
                </tr>
                <tr>
                  <td>vbf1_AK4_pt</td>
                  <td>14</td>
                </tr>
                <tr>
                  <td>vbf2_AK4_pt</td>
                  <td>15</td>
                </tr>
              </table>
            </div>
            <div class="column3"></div>
          </div>
        </div>
        <p>DNN_GPU doesn't give a variable ranking. MLPBFGS does, and performs roughly the same as DNN_GPU (or sometimes  even better) based on AUC. MLPBFGS gives a warning that I don't totally understand it's importance. "Line search increased error. Something is wrong!"</p>
      </div>
      <hr class="break">

      <button class="collapsible">Week of: Jan 16th, 2022</button>
      <div class="content">
        <li><p> I need to figure out which weights need to be applied to the training step. There's options for both  overall weights applied per tree, and weight expressions that are applied on an event by event basis. Right now  there's just one called "mcWeight" which is xsec/nMCgen, and the overall background weight of 1.</p>
          <p>There are multiple event weight branches, I just don't know which ones are actually supposed to be used, or  what some of them even are. Is there a reference for these (or any) datasets on the twiki? Here is the list of   the weights included in the ntuples: 
            <ul>
              <li>mcWeight :&emsp;xsec/nMCgen</li>
              <li>aqgcWeight / nAqgcWeight : aqgcWeight[1000]</li>
              <li>pdfWeight / nPdfWeight : pdfWeight[200]</li>
              <li>scaleWeight / nScaleWeight : scaleWeight[200]</li>
              <li>btagWeight_* : where * can be loose, medium, or tight followed by up, down, or nothing</li>
              <li>genWeight</li>
              <li>L1PFWeight : nothing, _Up, or _Down</li>
              <li>LHEWeight : LHEWeight[1164]</li>
              <li>lep*_idEffWeight : 1 or 2</li>
              <li>lep*_trigEffWeight : 1 or 2</li>
              <li>puWeight* : _Up, _down, or nothing</li>
            </ul>
          </p>
        </li>
        <li><h5>Links for plots using different sets of weights</h5>
          <p style="margin-top: 0px; margin-bottom: 0px;">Using weights: <span style="color:darkred"> mcWeight, genWeight, L1PFWeight, btagWeight_loose, lep1_idEffWeight, lep1_trigEffWeight, lep2_idEffWeight, lep2_trigEffWeight</span></p>
            <div class="row" style="height: 50px;">
              <div class="column3"><h5 class="link"><a href="img/week_of_16th/2016_multiplot_set_20-27.pdf">2016</a></h5></div>
              <div class="column3"><h5 class="link"><a href="img/week_of_16th/2017_multiplot_set_19-54.pdf">2017</a></h5></div>
              <div class="column3"><h5 class="link"><a href="img/week_of_16th/2018_multiplot_set_4-51.pdf">2018</a></h5></div>
            </div>
          <p style="margin-top: 0px; margin-bottom: 0px;">Using weights: <span style="color:darkred"> mcWeight, genWeight, L1PFWeight, btagWeight_loose</span></p>
            <div class="row" style="height: 50px;">
              <div class="column3"><h5 class="link"><a href="img/week_of_16th/2016_multiplot_set_20-57.pdf">2016</a></h5></div>
              <div class="column3"><h5 class="link"><a href="img/week_of_16th/2017_multiplot_set_22-17.pdf">2017</a></h5></div>
              <div class="column3"><h5 class="link"><a href="img/week_of_16th/2018_multiplot_set_5-58.pdf">2018</a></h5></div>
            </div>
        </li>
      </div>
      <hr class="break">

      <button class="collapsible">Week of: Jan 30th, 2022</button>
      <div class="content">
        <li>
          <p>Progress! Of the three main issues I've been having (weird BDT responses, normalizations being off, and not being able to plot control regions) I fixed two of them. The weird BDT/Neural net responses, and the control regions seem to be fixed. I realized I wasn't processing data events where <span class="inline_code">vbs(1/2)_AK4_qgid</span> were NaN. A while ago I was getting errors on those events so I ignored them while the MVA methods were being applied. Unfortunately I didn't actually cut those events out, they just didn't get processed. All of those events are probably what went into that one large bin in the DNN plot, and those events not being processed is probably what caused the drop in data for the BDT response.</p>
          <p>As far as the control region issue I can't believe it took me this long to see the solution. All three regions (top, w+jets, and signal) have common cuts (literally called common) I can train using the common cuts and then I can apply the final set of cuts when I go to make the plots. The MVA responses might be a bit different because there's more events to train on, but I don't think it will make a massive difference.</p>
          <p>I'm still having issues with the normalizations. I have two main sets of weights that I've been applying to the training and plots, and I've been working on comparing them.</p>

          <div class="link_list">
            <p style="margin-top: 0px; margin-bottom: 0px;">Weight1: <span style="color:firebrick"> mcWeight, genWeight, L1PFWeight, btagWeight_loose, lep1_idEffWeight, lep1_trigEffWeight</span></p>
            <div class="row">
              <div class="column3"><h5 class="link"><a href="img/week_of_23rd/2016/2016_Weight1_SR.pdf">2016 SR</a></h5></div>
              <div class="column3"><h5 class="link"><a href="img/week_of_23rd/2017/2017_Weight1_SR.pdf">2017 SR</a></h5></div>
              <div class="column3"><h5 class="link"><a href="img/week_of_23rd/2018/2018_Weight1_SR.pdf">2018 SR</a></h5></div>
            </div>
            <div class="row">
              <div class="column3"><h5 class="link"><a href="img/week_of_23rd/2016/2016_Weight1_Top_CR.pdf">2016 Top</a></h5></div>
              <div class="column3"><h5 class="link"><a href="img/week_of_23rd/2017/2017_Weight1_Top_CR.pdf">2017 Top</a></h5></div>
              <div class="column3"><h5 class="link"><a href="img/week_of_23rd/2018/2018_Weight1_Top_CR.pdf">2018 Top</a></h5></div>
            </div>
            <div class="row">
              <div class="column3"><h5 class="link"><a href="img/week_of_23rd/2016/2016_Weight1_Wjets_CR.pdf">2016 W + jets</a></h5></div>
              <div class="column3"><h5 class="link"><a href="img/week_of_23rd/2017/2017_Weight1_Wjets_CR.pdf">2017 W + jets</a></h5></div>
              <div class="column3"><h5 class="link"><a href="img/week_of_23rd/2018/2018_Weight1_Wjets_CR.pdf">2018 W + jets</a></h5></div>
            </div>
            <p style="margin-top: 0px; margin-bottom: 0px;">Weight2: <span style="color:firebrick">mcWeight, genWeight</span></p>
            <div class="row">
              <div class="column3"><h5 class="link"><a href="img/week_of_23rd/2016/2016_Weight2_SR.pdf">2016 SR</a></h5></div>
              <div class="column3"><h5 class="link"><a href="img/week_of_23rd/2017/2017_Weight2_SR.pdf">2017 SR</a></h5></div>
              <div class="column3"><h5 class="link"><a href="img/week_of_23rd/2018/2018_Weight2_SR.pdf">2018 SR</a></h5></div>
            </div>
            <div class="row">
              <div class="column3"><h5 class="link"><a href="img/week_of_23rd/2016/2016_Weight2_Top_CR.pdf">2016 Top</a></h5></div>
              <div class="column3"><h5 class="link"><a href="img/week_of_23rd/2017/2017_Weight2_Top_CR.pdf">2017 Top</a></h5></div>
              <div class="column3"><h5 class="link"><a href="img/week_of_23rd/2018/2018_Weight2_Top_CR.pdf">2018 Top</a></h5></div>
            </div>
            <div class="row">
              <div class="column3"><h5 class="link"><a href="img/week_of_23rd/2016/2016_Weight2_Wjets_CR.pdf">2016 W + jets</a></h5></div>
              <div class="column3"><h5 class="link"><a href="img/week_of_23rd/2017/2017_Weight2_Wjets_CR.pdf">2017 W + jets</a></h5></div>
              <div class="column3"><h5 class="link"><a href="img/week_of_23rd/2018/2018_Weight2_Wjets_CR.pdf">2018 W + jets</a></h5></div>
            </div>
          </div>
          <br>
          <p>I also have Top and Wjets control region plots with both of those sets of weights. Maybe there's a "best" set of weights I should be using and then I'll still need to scale things a bit based on the control regions.</p>
          <p>Here's a list of the data and background counts for each plot</p>
          <div>
            <div class="row">
              <div class="column3">
                <table width="100%">
                  <tr>
                    <td><b>Weight 1</b></td>
                    <td><b>Data</b></td>
                    <td><b>MC</b></td>
                  </tr>
                  <tr>
                    <td>2016 SR</td>
                    <td>1478</td>
                    <td>1206</td>
                  </tr>
                  <tr>
                    <td>2016 Top</td>
                    <td>7840</td>
                    <td>8585</td>
                  </tr>
                  <tr>
                    <td>2016 W+jets</td>
                    <td>933</td>
                    <td>677</td>
                  </tr>
                  <tr>
                    <td><b>Weight 2</b></td>
                    <td><b>Data</b></td>
                    <td><b>MC</b></td>
                  </tr>
                  <tr>
                    <td>2016 SR</td>
                    <td>1478</td>
                    <td>1344</td>
                  </tr>
                  <tr>
                    <td>2016 Top</td>
                    <td>7840</td>
                    <td>9573</td>
                  </tr>
                  <tr>
                    <td>2016 W+jets</td>
                    <td>933</td>
                    <td>763</td>
                  </tr>
                </table>
              </div>
              <div class="column3">
                <table width="100%">
                  <tr>
                    <td><b>Weight 1</b></td>
                    <td><b>Data</b></td>
                    <td><b>MC</b></td>
                  </tr>
                  <tr>
                    <td>2017 SR</td>
                    <td>1711</td>
                    <td>1567</td>
                  </tr>
                  <tr>
                    <td>2017 Top</td>
                    <td>8339</td>
                    <td>8968</td>
                  </tr>
                  <tr>
                    <td>2017 W+jets</td>
                    <td>1051</td>
                    <td>1021</td>
                  </tr>
                  <tr>
                    <td><b>Weight 2</b></td>
                    <td><b>Data</b></td>
                    <td><b>MC</b></td>
                  </tr>
                  <tr>
                    <td>2017 SR</td>
                    <td>1711</td>
                    <td>1776</td>
                  </tr>
                  <tr>
                    <td>2017 Top</td>
                    <td>8339</td>
                    <td>10218</td>
                  </tr>
                  <tr>
                    <td>2017 W+jets</td>
                    <td>1051</td>
                    <td>1165</td>
                  </tr>
                </table>
              </div>
              <div class="column3">
                <table width="100%">
                  <tr>
                    <td><b>Weight 2</b></td>
                    <td><b>Data</b></td>
                    <td><b>MC</b></td>
                  </tr>
                  <tr>
                    <td>2018 SR</td>
                    <td>1491</td>
                    <td>1768</td>
                  </tr>
                  <tr>
                    <td>2018 Top</td>
                    <td>8852</td>
                    <td>13232</td>
                  </tr>
                  <tr>
                    <td>2018 W+jets</td>
                    <td>947</td>
                    <td>1074</td>
                  </tr>
                  <tr>
                    <td><b>Weight 2</b></td>
                    <td><b>Data</b></td>
                    <td><b>MC</b></td>
                  </tr>
                  <tr>
                    <td>2018 SR</td>
                    <td>1491</td>
                    <td>2113</td>
                  </tr>
                  <tr>
                    <td>2018 Top</td>
                    <td>8852</td>
                    <td>13199</td>
                  </tr>
                  <tr>
                    <td>2018 W+jets</td>
                    <td>947</td>
                    <td>1306</td>
                  </tr>
                </table>
              </div>
            </div>
          </div>
        </li>
        <li>
          <p>I also made SR plots without the <span class="inline_code">isAntiIso == 0</span> cut. These are shown below.</p>
          <div class="link_list">
            <p style="margin-top: 0px; margin-bottom: 0px;">Weight1:</p>
            <div class="row">
              <div class="column3"><h5 class="link"><a href="img/week_of_23rd/2016/2016_Weight1_SR_noAntiIso.pdf">2016 SR No Anti Iso cut</a></h5></div>
              <div class="column3"><h5 class="link"><a href="img/week_of_23rd/2017/2017_Weight1_SR_noAntiIso.pdf">2017 SR No Anti Iso cut</a></h5></div>
              <div class="column3"><h5 class="link"><a href="img/week_of_23rd/2018/2018_Weight1_SR_noAntiIso.pdf">2018 SR No Anti Iso cut</a></h5></div>
            </div>
            <p style="margin-top: 0px; margin-bottom: 0px;">Weight2:</p>
            <div class="row">
              <div class="column3"><h5 class="link"><a href="img/week_of_23rd/2016/2016_Weight2_SR_noAntiIso.pdf">2016 SR No Anti Iso cut</a></h5></div>
              <div class="column3"><h5 class="link"><a href="img/week_of_23rd/2017/2017_Weight2_SR_noAntiIso.pdf">2017 SR No Anti Iso cut</a></h5></div>
              <div class="column3"><h5 class="link"><a href="img/week_of_23rd/2018/2018_Weight2_SR_noAntiIso.pdf">2018 SR No Anti Iso cut</a></h5></div>
            </div>
          </div>
          <br>
          <div>
            <div class="row">
              <div class="column3">
                <table width="100%">
                  <tr>
                    <td><b>Weight 1</b></td>
                    <td><b>Data</b></td>
                    <td><b>MC</b></td>
                  </tr>
                  <tr>
                    <td>2016 SR</td>
                    <td>1780</td>
                    <td>1292</td>
                  </tr>
                  <tr>
                    <td><b>Weight 2</b></td>
                    <td><b>Data</b></td>
                    <td><b>MC</b></td>
                  </tr>
                  <tr>
                    <td>2016 SR</td>
                    <td>1780</td>
                    <td>1439</td>
                  </tr>
                </table>
              </div>
              <div class="column3">
                <table width="100%">
                  <tr>
                    <td><b>Weight 1</b></td>
                    <td><b>Data</b></td>
                    <td><b>MC</b></td>
                  </tr>
                  <tr>
                    <td>2017 SR</td>
                    <td>1939</td>
                    <td>1628</td>
                  </tr>
                  <tr>
                    <td><b>Weight 2</b></td>
                    <td><b>Data</b></td>
                    <td><b>MC</b></td>
                  </tr>
                  <tr>
                    <td>2017 SR</td>
                    <td>1939</td>
                    <td>1864</td>
                  </tr>
                </table>
              </div>
              <div class="column3">
                <table width="100%">
                  <tr>
                    <td><b>Weight 2</b></td>
                    <td><b>Data</b></td>
                    <td><b>MC</b></td>
                  </tr>
                  <tr>
                    <td>2018 SR</td>
                    <td>1817</td>
                    <td>1859</td>
                  </tr>
                  </tr>
                  <tr>
                    <td><b>Weight 2</b></td>
                    <td><b>Data</b></td>
                    <td><b>MC</b></td>
                  </tr>
                  <tr>
                    <td>2018 SR</td>
                    <td>1817</td>
                    <td>2219</td>
                  </tr>
                </table>
              </div>
            </div>
          </div>
        </li>
      </div>
    </ul>

  </div>

<!--

-->
<script>
  var coll = document.getElementsByClassName("collapsible");
  var i;
  
  for (i = 0; i < coll.length; i++) {
    coll[i].addEventListener("click", function() {
      this.classList.toggle("active");
      var content = this.nextElementSibling;
      if (content.style.maxHeight){
        content.style.maxHeight = null;
      } else {
        content.style.maxHeight = content.scrollHeight + "px";
      } 
    });
  }
  </script>

</body>
</html>